# =============================================================================
# PROJECT IDENTITY: GANTRYFLEET (Enterprise AI Software Factory)
# =============================================================================
# Copyright 2026 Pramod Kumar Voola. Apache License 2.0.
# Enterprise Inquiries: pramod.voola@gmail.com
# =============================================================================
#
# Core Concept:
# GantryFleet is an enterprise-grade, AI-powered software factory. It enables 
# architects to build, audit, and deploy software artifacts through natural 
# language commands, with complete audit trails and zero-trust security.
#
# The GantryFleet Guarantee (Zero-Trust):
# 1. "No Touch" Build: Code is generated and run inside isolated Project Pods.
# 2. "Green Light" Deploy: Code is only pushed if the Critic Agent passes audits.
# 3. "Black Box" Evidence: Every mission records a cryptographic audit trail.
# 4. "95% Mockup Fidelity": Design uploads are matched with visual precision.
#
# Technical Stack (V7.0 Production Architecture):
# - Brain: AWS Bedrock (Claude 3.5 Sonnet) with Vision/Multimodal Support
# - Body: Docker (via Secure Proxy)
# - Uplink: Cloudflare Tunnel (version-controlled config)
# - Storage: PostgreSQL (Connection Pooled with Timeouts)
# - API: FastAPI (Async, WebSocket, OpenAPI)
# - Auth: Argon2 + TokenBucket Rate Limiting
# =============================================================================

# -----------------------------------------------------------------------------
# 1. SECURITY & SAFETY (NON-NEGOTIABLE)
# -----------------------------------------------------------------------------
- PROXY PROTOCOL:
  - NEVER connect to `/var/run/docker.sock` directly.
  - ALWAYS connect via `tcp://docker-proxy:2375`.
- DEAD MAN'S SWITCH:
  - Every Project Pod must have a hard TTL (180 seconds).
  - If a build hangs, the Watchdog thread must kill it.
- IAM AUTHENTICATION:
  - Do NOT use hardcoded AWS keys. Use the Default Credential Chain.
- **SECRETS POLICY (CRITICAL)**:
  - NEVER commit secrets, API keys, tokens, or credentials to git.
  - NEVER reference user's work profiles, account IDs, or employer details.
  - NEVER include AWS account numbers, profile names, or ARNs in committed code.
  - ALL sensitive values MUST use placeholders (e.g., YOUR_API_KEY, YOUR_PROFILE).
  - Store secrets ONLY in .env files (which are gitignored).
  - Before ANY git commit, scan for: API keys, tokens, account IDs, profile names.

# -----------------------------------------------------------------------------
# 2. HEADLESS UX (DRIVER SAFETY)
# -----------------------------------------------------------------------------
- AUDIO FEEDBACK:
  - Every API response must include a `speech` field for TTS.
  - Keep speech concise: "Gantry copying. Pod launched." (Not verbose).

# -----------------------------------------------------------------------------
# 3. CODING STANDARDS
# -----------------------------------------------------------------------------
- Use `pydantic` for all Manifests.
- Use `psycopg2` with `SimpleConnectionPool` for Database.
- Use `rich` for all console output.
- Wrap all external calls (AWS/Docker) in try/except blocks.

# -----------------------------------------------------------------------------
# 4. HEADLESS PROTOCOL (DRIVER SAFETY)
# -----------------------------------------------------------------------------
- AUDIO FIRST: Every API response MUST include a `speech` field with concise,
  natural language text for TTS engines (e.g., iOS Shortcuts).
- BLACK BOX LOGGING:
  - Every mission MUST create a dedicated folder: `missions/{mission_id}/`.
  - REQUIRED ARTIFACTS: `flight_recording.json`, `manifest.json`, `audit_report.json`.
  - The system must write these files *even if the mission fails*.

# -----------------------------------------------------------------------------
# 5. RESOURCE SAFETY (DEAD MAN'S SWITCH)
# -----------------------------------------------------------------------------
- TIME-TO-LIVE (TTL):
  - Sibling containers must ALWAYS be spawned with a strict timeout or be
    monitored by a watchdog thread.
  - HARD LIMIT: 180 seconds (3 minutes) per build. Kill the container if exceeded.
- RESOURCE LIMITS:
  - Docker containers must specify `mem_limit="512m"` to prevent memory leaks.

# -----------------------------------------------------------------------------
# 6. CLOUD SECURITY (AWS IAM)
# -----------------------------------------------------------------------------
- NO LONG-TERM KEYS:
  - Do NOT use `AWS_ACCESS_KEY_ID` or `AWS_SECRET_ACCESS_KEY` environment variables.
  - Rely on the EC2/Container Instance Role (Default Credential Provider Chain).
  - Initialize boto3 clients simply as `boto3.client("bedrock-runtime", region_name="us-east-1")`
    without passing explicit keys.

# -----------------------------------------------------------------------------
# 7. DOCUMENTATION
# -----------------------------------------------------------------------------
- Every major module (`architect.py`, `foundry.py`, `fleet.py`) must have a top-level comment describing its responsibility in the Fleet.
- Update the README.md whenever a new dependency is added.
- **STRICT: NEVER create new .md files without explicit user approval.** Ask first.

# -----------------------------------------------------------------------------
# 8. DEPLOYMENT (VERCEL CLI)
# -----------------------------------------------------------------------------
- REAL URL REQUIREMENT:
  - Every successful mission MUST result in a live HTTP endpoint.
  - Use `vercel-cli` for instant deployments.
  - COMMAND: `vercel deploy --prod --token $VERCEL_TOKEN --yes`
  - CAPTURE: The stdout contains the Production URL. Parse it.
- BUILDER IMAGE:
  - Use `gantry/builder:latest` for all Project Pods.
  - Image includes: Python 3.11, Node.js 20, Git, Vercel CLI.
  - Pass VERCEL_TOKEN securely from host environment.

# -----------------------------------------------------------------------------
# 9. GIT SAFETY (JUNIOR DEV MODEL)
# -----------------------------------------------------------------------------
# Gantry operates like a Junior Developer - it proposes, YOU approve.
#
- **NEVER PUSH TO MAIN**:
  - NEVER push directly to `main` or `master` branch.
  - ALWAYS create a unique feature branch: `feat/{project}-{short_id}`.
  - ALWAYS open a Pull Request (PR) for human review.
- **PR WORKFLOW**:
  - Create branch → Push branch → Open PR via GitHub API.
  - PR Title: "Gantry Mission: {project_name}"
  - PR Body: Include audit status and evidence path.
  - Return the PR URL for review notification.
- **WHY**: This prevents accidental secret leaks and maintains human oversight.
  Gantry is your Staff Engineer; YOU remain the Lead.

# -----------------------------------------------------------------------------
# 10. CODE QUALITY CRITIC LAYER (STRICT ENFORCEMENT)
# -----------------------------------------------------------------------------
# Before writing or modifying ANY code, apply these quality gates:
#
- **DRY (Don't Repeat Yourself)**:
  - NEVER duplicate code. Extract common logic into functions/classes.
  - If you see similar code blocks, REFACTOR immediately.
  - Use helper functions, base classes, and composition.
- **TIME COMPLEXITY**:
  - Always consider Big-O complexity.
  - Avoid O(n²) when O(n) is possible. Document complexity in comments.
  - Use appropriate data structures (dict for O(1) lookup, not list).
- **STRICT LINTING**:
  - Run `read_lints` BEFORE declaring any code complete.
  - Zero linting errors allowed. Fix all warnings.
  - Follow PEP 8 for Python, ESLint rules for JS/TS.
- **PYDANTIC MODELS**:
  - ALL data structures must use Pydantic models.
  - No raw dicts for structured data. Define proper schemas.
  - Use validators for complex fields.
- **SYSTEM DESIGN PRINCIPLES**:
  - Single Responsibility: Each class/function does ONE thing.
  - Open/Closed: Open for extension, closed for modification.
  - Dependency Injection: Pass dependencies, don't hardcode.
  - Separation of Concerns: Keep layers distinct (API, Core, Infra).
- **ARCHITECTURE PATTERNS**:
  - Follow existing patterns in codebase. Don't introduce new ones without reason.
  - Use the established folder structure: `src/core/`, `src/infra/`, `src/domain/`.
  - Interfaces before implementations.
- **NO CODE BLOAT**:
  - Every line must have a purpose. Delete dead code.
  - Prefer composition over inheritance.
  - Keep functions under 50 lines. Split if longer.
  - Maximum 3 levels of nesting. Flatten with early returns.
- **ERROR HANDLING**:
  - Never swallow exceptions. Log them at minimum.
  - Use specific exception types, not bare `except:`.
  - Fail fast with clear error messages.

# -----------------------------------------------------------------------------
# 11. DEFINITION OF DONE (STRICT ENFORCEMENT)
# -----------------------------------------------------------------------------
# A task is NOT complete until ALL of the following are verified:
#
- **NO UNTESTED CODE**: Never declare code "complete" or "ready" without running tests.
- **VERIFY BEFORE CONFIRM**: Execute the code, observe the output, confirm it works.
- **ALL RULES APPLY**: Every rule in this file must be followed. No exceptions.
- **SAY "READY" ONLY WHEN TESTED**: The words "done", "complete", or "ready" are 
  FORBIDDEN until tests have passed and functionality is confirmed.
#
# Workflow Checklist (Must complete in order):
# 1. Write/modify code following all standards above.
# 2. Run linter checks (read_lints).
# 3. Execute tests or manual verification.
# 4. Observe output and confirm expected behavior.
# 5. ONLY THEN may you declare the task complete.
#
# If testing is not possible (e.g., requires external service), explicitly state:
# "PENDING VERIFICATION: [reason]" — never claim completion.

# -----------------------------------------------------------------------------
# 12. PROTOTYPING STRATEGY FOR LARGER WEBSITES (RESOURCE OPTIMIZATION)
# -----------------------------------------------------------------------------
# When building "larger websites" or "big website prototypes":
#
- **BUILD IN PHASES**: Start with a lighter prototype, deploy, verify, then iterate.
- **NO ORM IN PROTOTYPES**: Gantry deploys to serverless (Vercel) without databases.
  - Use localStorage for client-side persistence
  - Use JSON files or mock APIs for initial data
  - Advise users they can add Supabase/PlanetScale/MongoDB later
- **PROGRESSIVE ENHANCEMENT**:
  1. Phase 1: Static UI with mock data (quick to build & deploy)
  2. Phase 2: Add interactivity with localStorage
  3. Phase 3: Connect to external services (user adds API keys)
- **RESOURCE AWARENESS**:
  - Build times are limited to 180 seconds
  - Container memory is 512MB
  - Suggest breaking complex apps into microservices
- **CONSULTATION GUIDANCE**:
  - When user asks for "database", "user accounts", or "big website":
    - Explain we'll build a working prototype first
    - Mention they can add a real database after deployment
    - Offer to structure code for easy DB integration later
- **EXAMPLE RESPONSE**:
  "I'll build a working LinkedIn clone prototype using localStorage for data. 
   After we verify it's deployed and working, you can connect it to Supabase 
   for real user accounts. This approach ensures we deliver fast and avoid 
   resource timeouts. Shall I proceed?"

# -----------------------------------------------------------------------------
# 13. ARCHITECTURE V7.0 PATTERNS (REQUIRED)
# -----------------------------------------------------------------------------
# GantryFleet V7.0 Production Architecture. Follow these patterns:
#
- **FASTAPI ASYNC CORE**:
  - Use `main_fastapi.py` as the primary entrypoint.
  - All endpoints MUST be async (`async def`).
  - Use dependency injection via `Depends()`.
  - Leverage auto-generated OpenAPI docs at `/docs`.
- **WEBSOCKET FOR REAL-TIME**:
  - Use WebSocket (`/gantry/ws/{mission_id}`) for status updates.
  - Broadcast via `ConnectionManager.broadcast()`.
  - Never rely on HTTP polling for real-time updates.
- **ARGON2 FOR PASSWORDS**:
  - Use `auth.py` with Argon2 password hashing (NOT SHA256/MD5).
  - Support pre-hashed passwords via `GANTRY_PASSWORD_HASH` env var.
- **TOKEN BUCKET RATE LIMITING**:
  - Apply per-user rate limiting with TokenBucket (not just per-IP).
  - Both `RateLimiter` (IP) and `TokenBucket` (user) must be used.
- **VISION/MULTIMODAL SUPPORT**:
  - The Architect supports image inputs for mockup matching.
  - Design images are saved to `missions/{mission_id}/design-reference.{ext}`.
  - Claude processes images for 95% visual fidelity.
- **3-TIER MODEL FALLBACK**:
  - Tier 1: Claude 4 Sonnet (most capable)
  - Tier 2: Claude 4 Sonnet (balanced)
  - Tier 3: Claude 3.5 Sonnet (battle-tested)
  - Simple apps NEVER fail. Complex apps get 3 chances.
  - Configured in `architect.py` via `MODEL_TIERS` list.
- **PLUGGABLE SKILLS**:
  - New AI capabilities go in `src/skills/{skill-name}/`.
  - Each skill has: `handler.py`, `__init__.py`, `SKILL.md`.
  - Skills auto-load at startup via `SkillRegistry.load_all()`.
- **SPLIT FUNCTIONS**:
  - Split long functions into phases: `_phase_architect()`, `_phase_build()`, etc.
  - Maximum 50 lines per function enforced.

# -----------------------------------------------------------------------------
# 14. FILE NAMING CONVENTIONS
# -----------------------------------------------------------------------------
- **PRIMARY MODULES** (V7.0 Production):
  - `main_fastapi.py` - Primary API entry point (FastAPI)
  - `fleet.py` - Async Fleet Manager with WebSocket support
  - `architect.py` - AI Blueprint Generator with Vision support
  - `consultant.py` - CTO Consultation Loop with iteration planning
  - `auth.py` - Argon2 auth with TokenBucket rate limiting
  - `foundry.py` - Docker container build orchestration
  - `deployer.py` - Vercel deployment with timeout protection
  - `publisher.py` - GitHub PR automation
- **SKILLS**: `src/skills/{skill-name}/handler.py`
- **PROMPTS**: `prompts/{prompt-name}.md`
- **TESTS**: `tests/test_{module}.py`

# -----------------------------------------------------------------------------
# 15. MOCKUP/SCREENSHOT MATCHING (95% VISUAL FIDELITY)
# -----------------------------------------------------------------------------
# When users upload design mockups, screenshots, or sketches:
#
- **VISION ANALYSIS**:
  - The Architect analyzes uploaded images using Claude's vision capabilities.
  - Images are stored at `missions/{mission_id}/design-reference.{ext}`.
  - ALL visual elements must be replicated: layout, colors, typography, spacing.
- **95% ACCURACY TARGET**:
  - EXACT color values (extract hex from mockup)
  - EXACT layout structure (columns, rows, spacing, alignment)
  - EXACT typography (font sizes, weights, line-heights)
  - EXACT component styles (buttons, inputs, cards, borders, shadows)
  - EXACT spacing and padding patterns
- **README DOCUMENTATION**:
  - Generated repos MUST include the mockup in README.md:
    ```
    ## Design Reference
    This project was built to match the following design mockup:
    
    ![Design Mockup](./design-reference.png)
    
    The UI has been crafted to achieve 95%+ visual fidelity.
    ```
- **CSS PRECISION**:
  - Use CSS custom properties for colors (--primary, --secondary, etc.)
  - Match border-radius precisely (sharp, rounded, or pill-shaped)
  - Match shadow depths and blur radii
  - Match font weights and letter-spacing

# -----------------------------------------------------------------------------
# 16. UI/UX QUALITY STANDARDS (STAFF ENGINEER LEVEL)
# -----------------------------------------------------------------------------
# The Architect agent MUST produce UIs that meet professional standards.
# Act like a Staff Engineer with 10+ years of experience.
#
- **TYPOGRAPHY**:
  - ALWAYS use proper font stacks: `'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`
  - Font sizes must be readable: minimum 14px for body text, 12px for captions
  - Line-height: 1.5-1.6 for body text, 1.3 for headings
  - NEVER use default browser fonts without explicit font-family
- **TEXT HANDLING**:
  - ALWAYS set `word-wrap: break-word; overflow-wrap: break-word; word-break: break-word;` on text containers
  - FLEXBOX FIX: Add `min-width: 0;` to flex children containing text (prevents overflow!)
  - ALWAYS wrap text content in a `<span>` inside flex containers
  - Long text must NOT overflow containers - use `text-overflow: ellipsis` where needed
  - Prevent orphaned words with `hyphens: auto` for paragraphs
  - Set appropriate `max-width` for text columns (60-80ch for readability)
- **SPACING & LAYOUT**:
  - Use consistent spacing scale (4px, 8px, 12px, 16px, 24px, 32px, 48px)
  - Padding inside cards: minimum 16px
  - Margins between sections: minimum 24px
  - NEVER let elements touch container edges without padding
- **COLORS & CONTRAST**:
  - Use CSS variables for theming: `--primary`, `--secondary`, `--background`, `--text`
  - Ensure WCAG AA contrast ratios (4.5:1 for text, 3:1 for large text)
  - Define hover, focus, and active states for interactive elements
- **RESPONSIVE DESIGN**:
  - ALWAYS include viewport meta tag: `<meta name="viewport" content="width=device-width, initial-scale=1.0">`
  - Use flexbox or grid for layouts, NOT floats
  - Test layouts at 320px, 768px, and 1200px breakpoints
  - Mobile-first approach: start with mobile styles, add media queries for larger screens
- **PROFESSIONAL POLISH**:
  - Smooth transitions: `transition: all 0.2s ease`
  - Subtle shadows for depth: `box-shadow: 0 2px 8px rgba(0,0,0,0.08)`
  - Border-radius for modern look: 6px-12px for cards, 4px for inputs
  - Focus states for accessibility: `outline: 2px solid var(--primary)`
- **COMMON MISTAKES TO AVOID**:
  - NO tiny fonts (less than 12px)
  - NO text that overflows its container
  - NO buttons without hover states
  - NO forms without proper labels and validation feedback
  - NO horizontal scrolling on mobile
  - NO elements that touch screen edges on mobile (use safe padding)

# -----------------------------------------------------------------------------
# 17. LEGAL COMPLIANCE (APACHE 2.0)
# -----------------------------------------------------------------------------
# GantryFleet is licensed under Apache License 2.0.
#
- **SOURCE FILE HEADERS**:
  - ALL Python source files in src/ MUST have Apache 2.0 header:
    ```python
    # Copyright 2026 Pramod Kumar Voola
    #
    # Licensed under the Apache License, Version 2.0 (the "License");
    # you may not use this file except in compliance with the License.
    # You may obtain a copy of the License at
    #
    #     http://www.apache.org/licenses/LICENSE-2.0
    ```
- **REQUIRED FILES**:
  - `LICENSE` - Full Apache 2.0 license text
  - `NOTICE` - Copyright attribution (travels with all forks)
- **THIRD-PARTY ATTRIBUTION**:
  - Document all dependencies in NOTICE file
  - Respect licenses of all dependencies
- **ENTERPRISE CONTACT**:
  - For advanced features or subscription engagement:
  - Contact: Pramod Kumar Voola (pramod.voola@gmail.com)

# -----------------------------------------------------------------------------
# 18. GENERATED REPO STANDARDS
# -----------------------------------------------------------------------------
# When the Architect generates code that gets deployed, it MUST include:
#
- **README.md** with:
  - Project description
  - Design reference (if mockup was provided)
  - Setup instructions
  - Live demo URL
- **STRUCTURE**:
  - `public/index.html` - Main HTML entry
  - `api/index.js` - Serverless API (if needed)
  - `vercel.json` - Deployment config
  - `package.json` - Dependencies
  - `tests/index.test.js` - Unit tests (90% coverage target)
- **MOCKUP REFERENCE** (when user uploads design):
  - Copy mockup to `design-reference.{ext}` in repo
  - Reference in README: `![Design Mockup](./design-reference.png)`
  - Include accuracy statement: "Built to match design at 95%+ fidelity"
