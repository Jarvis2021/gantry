<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GantryFleet</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff;
            --bg-alt: #f8f9fa;
            --bg-hover: #f1f3f5;
            --text: #212529;
            --text-secondary: #6c757d;
            --text-muted: #adb5bd;
            --border: #dee2e6;
            --blue: #0066cc;
            --blue-hover: #0052a3;
            --green: #198754;
            --green-bg: #d1e7dd;
            --yellow: #cc8800;
            --yellow-bg: #fff3cd;
            --red: #dc3545;
            --red-bg: #f8d7da;
            --gray-bg: #e9ecef;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            font-size: 12px;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            flex-shrink: 0;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .brand-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .brand-icon img { width: 32px; height: 32px; border-radius: 6px; }
        .brand-text { font-size: 14px; font-weight: 600; }

        .header-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 10px;
            color: var(--green);
        }

        .status-dot {
            width: 5px;
            height: 5px;
            background: var(--green);
            border-radius: 50%;
        }

        /* Main */
        .main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Chat Panel - Equal width with projects */
        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-right: 1px solid var(--border);
            min-width: 0;
        }

        /* Projects Panel - Equal width with chat */
        .projects-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-alt);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .msg {
            display: flex;
            gap: 8px;
            max-width: 85%;
        }

        .msg.user { align-self: flex-end; flex-direction: row-reverse; }
        .msg.system { align-self: flex-start; }

        .msg-avatar {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .msg.user .msg-avatar { background: var(--blue); color: white; }
        .msg.system .msg-avatar { background: var(--bg-alt); color: var(--text-secondary); }

        .msg-content {
            padding: 8px 12px;
            border-radius: 10px;
            line-height: 1.5;
            font-size: 12px;
        }

        .msg.user .msg-content {
            background: var(--blue);
            color: white;
            border-bottom-right-radius: 3px;
        }

        .msg.system .msg-content {
            background: var(--bg-alt);
            border: 1px solid var(--border);
            border-bottom-left-radius: 3px;
        }

        .msg-content strong { font-weight: 600; }
        .msg-content ul { margin: 6px 0 0 14px; }
        .msg-content li { margin: 3px 0; }
        .msg-content code { background: rgba(0,0,0,0.08); padding: 1px 4px; border-radius: 3px; font-size: 11px; }

        /* Chat Input */
        .chat-input {
            padding: 10px 12px;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .input-row {
            display: flex;
            gap: 8px;
        }

        .input-field {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-size: 13px;
            outline: none;
            resize: vertical;
            min-height: 44px;
            max-height: 300px;
            line-height: 1.5;
        }

        .input-field:focus { border-color: var(--blue); box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.1); }
        .input-field::placeholder { color: var(--text-muted); }
        
        .input-hint {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 4px;
            text-align: right;
        }

        .send-btn {
            padding: 8px 14px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 6px;
            font-family: inherit;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
        }

        .send-btn:hover { background: var(--blue-hover); }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Image Upload */
        .upload-btn {
            padding: 8px 10px;
            background: var(--bg-alt);
            border: 1px solid var(--border);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .upload-btn:hover { background: var(--bg-hover); }
        .upload-btn svg { width: 16px; height: 16px; fill: var(--text-secondary); flex-shrink: 0; }
        .upload-label { font-size: 11px; color: var(--text-secondary); margin-left: 4px; }
        .upload-input { display: none; }
        
        .image-preview {
            margin-top: 8px;
            padding: 8px;
            background: var(--bg-alt);
            border-radius: 6px;
            display: none;
        }
        .image-preview.active { display: flex; align-items: center; gap: 10px; }
        .image-preview img {
            max-width: 80px;
            max-height: 60px;
            border-radius: 4px;
            object-fit: cover;
        }
        .image-preview .image-name {
            flex: 1;
            font-size: 11px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .image-preview .remove-image {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            color: var(--red);
            font-size: 14px;
        }
        
        .msg-image {
            margin-top: 8px;
            max-width: 200px;
            border-radius: 8px;
        }

        /* Projects Panel is defined above with chat panel for equal widths */

        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
        }

        .projects-title { font-size: 12px; font-weight: 600; }
        .projects-count { font-size: 10px; color: var(--text-muted); margin-left: 4px; }

        .refresh-btn {
            padding: 4px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .projects-header-actions { display: flex; gap: 6px; align-items: center; }
        .clear-btn {
            padding: 4px 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg);
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
        }
        .refresh-btn:hover, .clear-btn:hover { border-color: var(--blue); color: var(--blue); }
        .clear-btn:hover { border-color: var(--red); color: var(--red); }
        .retry-btn {
            background: none; border: none; padding: 0; font-size: inherit;
            cursor: pointer; color: var(--blue); text-decoration: underline;
        }
        .retry-btn:hover { color: var(--blue-hover); }
        .retry-btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .projects-list {
            flex: 1;
            overflow-y: auto;
            padding: 6px;
        }

        .project-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 10px;
            margin-bottom: 6px;
        }

        .project-card:hover { border-color: var(--blue); }

        .project-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .project-name { font-size: 11px; font-weight: 600; }
        .project-id { font-size: 9px; color: var(--text-muted); font-family: monospace; }

        .project-desc {
            font-size: 10px;
            color: var(--text-secondary);
            line-height: 1.3;
            margin-bottom: 6px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .project-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 9px;
            font-weight: 600;
        }

        .status-badge.queued { background: var(--gray-bg); color: var(--text-secondary); }
        .status-badge.building { background: var(--yellow-bg); color: var(--yellow); }
        .status-badge.live { background: var(--green-bg); color: var(--green); }
        .status-badge.failed { background: var(--red-bg); color: var(--red); }

        .project-actions { display: flex; gap: 4px; }

        .action-link {
            font-size: 10px;
            color: var(--blue);
            text-decoration: none;
            padding: 2px 6px;
            border-radius: 3px;
        }

        .action-link:hover { background: var(--bg-alt); text-decoration: underline; }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
            padding: 8px;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .page-btn {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 3px;
            background: var(--bg);
            font-size: 10px;
            cursor: pointer;
        }

        .page-btn:hover:not(:disabled) { border-color: var(--blue); }
        .page-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .page-info { font-size: 10px; color: var(--text-muted); }

        /* Empty */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px 15px;
            color: var(--text-muted);
            text-align: center;
        }

        .empty-state svg { width: 32px; height: 32px; fill: var(--text-muted); margin-bottom: 8px; }
        .empty-state h3 { font-size: 11px; font-weight: 600; margin-bottom: 3px; color: var(--text-secondary); }
        .empty-state p { font-size: 10px; }
        .projects-hint { font-size: 9px; color: var(--text-muted); margin-left: 4px; }

        /* Spinner */
        .spinner {
            width: 10px;
            height: 10px;
            border: 2px solid var(--border);
            border-top-color: var(--blue);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: inline-block;
            margin-right: 5px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Typing indicator */
        .typing { display: flex; gap: 3px; padding: 4px 0; }
        .typing span {
            width: 5px; height: 5px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing span:nth-child(1) { animation-delay: -0.32s; }
        .typing span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Mobile */
        @media (max-width: 768px) {
            .main { flex-direction: column; }
            .chat-panel { border-right: none; flex: 1; min-height: 50%; }
            .projects-panel { width: 100%; height: 45%; border-top: 1px solid var(--border); }
            .header { padding: 6px 10px; }
            .brand-text { font-size: 13px; }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        /* Login Overlay */
        /* Login Overlay - Mobile-First */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 16px;
            overflow: auto;
        }

        .login-overlay.hidden { display: none !important; }

        .login-card {
            background: var(--bg);
            border-radius: 16px;
            padding: 28px 24px;
            width: 100%;
            max-width: 320px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 6px;
            text-align: center;
        }

        .login-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            text-align: center;
            margin-bottom: 20px;
        }

        .login-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            margin-bottom: 16px;
            -webkit-appearance: none;
            appearance: none;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--blue);
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.15);
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--blue);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        .login-btn:hover { background: var(--blue-hover); }
        .login-btn:active { transform: scale(0.98); }
        .login-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .login-error {
            color: var(--red);
            font-size: 13px;
            text-align: center;
            margin-top: 12px;
            display: none;
            padding: 8px;
            background: var(--red-bg);
            border-radius: 6px;
        }

        .login-error.show { display: block; }

        /* Mobile-specific login fixes */
        @media (max-width: 400px) {
            .login-card {
                padding: 24px 20px;
                border-radius: 12px;
            }
            .login-input, .login-btn {
                font-size: 17px;
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <div class="login-title">GantryFleet</div>
            <div class="login-subtitle">Enter your password to continue</div>
            <form id="loginForm" onsubmit="login(); return false;">
                <input type="password" class="login-input" id="passwordInput" placeholder="Password" autocomplete="current-password" inputmode="text" enterkeyhint="go" required>
                <button type="submit" class="login-btn" id="loginBtn">Unlock</button>
            </form>
            <div class="login-error" id="loginError">Invalid password. Please try again.</div>
        </div>
    </div>

    <div class="app">
        <header class="header">
            <div class="brand">
                <div class="brand-icon">
                    <img src="/static/gantry-logo.png" alt="Gantry Fleet Logo">
                </div>
                <div class="brand-text">GantryFleet</div>
            </div>
            <div class="header-status">
                <span class="status-dot"></span>
                Online
            </div>
        </header>

        <div class="main">
            <div class="chat-panel">
                <div class="chat-messages" id="chat-messages">
                    <div class="msg system">
                        <div class="msg-avatar">G</div>
                        <div class="msg-content">
                            <strong>Welcome to GantryFleet</strong><br><br>
                            I'm your AI Architect Agent. Describe what you want to build—I'll analyze the requirements, break complex projects into iterations, and propose the optimal architecture before we start building.
                        </div>
                    </div>
                </div>
                <div class="chat-input">
                    <div class="input-row">
                        <label class="upload-btn" title="Attach image (mockup, screenshot, or design)" aria-label="Attach image">
                            <input type="file" class="upload-input" id="image-input" accept="image/*">
                            <svg viewBox="0 0 24 24"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>
                            <span class="upload-label">Image</span>
                        </label>
                        <textarea class="input-field" id="prompt-input" placeholder="Describe what you want to build in detail... Paste full project specs, PRDs, or feature lists (supports up to 200K tokens)" rows="2"></textarea>
                        <button class="send-btn" id="send-btn">Send</button>
                    </div>
                    <div class="input-hint">Tip: For complex projects, paste your full requirements. The AI Architect will analyze and suggest iterations.</div>
                    <div class="image-preview" id="image-preview">
                        <img id="preview-img" src="" alt="Preview">
                        <span class="image-name" id="image-name"></span>
                        <button class="remove-image" id="remove-image" title="Remove image">x</button>
                    </div>
                </div>
            </div>

            <div class="projects-panel">
                <div class="projects-header">
                    <div>
                        <span class="projects-title">Projects</span>
                        <span class="projects-count" id="projects-count">(0)</span>
                        <span class="projects-hint" title="Each build uses AWS Bedrock (Claude) for code generation">(AI-powered)</span>
                    </div>
                    <div class="projects-header-actions">
                        <button type="button" class="clear-btn" id="clear-btn" title="Clear all projects and start from scratch">Clear all</button>
                        <button type="button" class="refresh-btn" id="refresh-btn">Refresh</button>
                    </div>
                </div>
                <div class="projects-list" id="projects-list">
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                        <h3>No projects yet</h3>
                        <p>Start a conversation to build your first app</p>
                    </div>
                </div>
                <div class="pagination" id="pagination" style="display: none;">
                    <button class="page-btn" id="prev-btn" disabled>Prev</button>
                    <span class="page-info" id="page-info">1 / 1</span>
                    <button class="page-btn" id="next-btn" disabled>Next</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API = (typeof window !== 'undefined' && window.location.protocol !== 'file:') ? '' : 'http://localhost:5050';
        const ITEMS_PER_PAGE = 5;
        let currentPage = 1;
        let allProjects = [];
        let conversationHistory = [];
        let buildPrompt = '';
        let isAuthenticated = false;
        let pendingImage = null;  // For image upload support

        // Login elements
        const loginOverlay = document.getElementById('loginOverlay');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const loginError = document.getElementById('loginError');

        // Check auth on load
        async function checkAuth() {
            try {
                const res = await fetch(`${API}/gantry/auth/status`);
                const data = await res.json();
                if (data.authenticated) {
                    isAuthenticated = true;
                    loginOverlay.classList.add('hidden');
                } else {
                    // Not authenticated - show login and focus password
                    showLoginOverlay();
                }
            } catch (e) {
                console.error('Auth check failed:', e);
                // On error, show login overlay
                showLoginOverlay();
            }
        }

        // Show login overlay and focus password input
        function showLoginOverlay() {
            loginOverlay.classList.remove('hidden');
            // Small delay to ensure overlay is visible before focusing
            setTimeout(() => {
                passwordInput.focus();
                // On iOS, scroll into view
                passwordInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        // Login function
        async function login() {
            const password = passwordInput.value.trim();
            if (!password) return;

            loginBtn.disabled = true;
            loginBtn.textContent = 'Authenticating...';
            loginError.classList.remove('show');

            try {
                const res = await fetch(`${API}/gantry/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();

                if (data.authenticated) {
                    isAuthenticated = true;
                    loginOverlay.classList.add('hidden');
                    addMsg('Welcome to GantryFleet. You are now authenticated.', false);
                } else {
                    loginError.classList.add('show');
                }
            } catch (e) {
                console.error('Login failed:', e);
                loginError.textContent = 'Connection error. Please try again.';
                loginError.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Unlock';
            }
        }

        // Form handles Enter key automatically via onsubmit

        const chatMessages = document.getElementById('chat-messages');
        const promptInput = document.getElementById('prompt-input');
        const sendBtn = document.getElementById('send-btn');
        const refreshBtn = document.getElementById('refresh-btn');
        const projectsList = document.getElementById('projects-list');
        const projectsCount = document.getElementById('projects-count');
        const pagination = document.getElementById('pagination');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const pageInfo = document.getElementById('page-info');

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function extractUrl(speech) {
            if (!speech) return null;
            const match = speech.match(/https?:\/\/[^\s]+/);
            return match ? match[0].replace(/[.,]$/, '') : null;
        }

        function generateAppName(prompt) {
            const words = prompt.toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .split(/\s+/)
                .filter(w => w.length > 2 && !['the', 'and', 'for', 'with', 'that', 'this', 'build', 'create', 'make', 'want', 'need', 'please', 'can', 'you'].includes(w));
            if (words.length >= 2) return words.slice(0, 2).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            return words[0] ? words[0].charAt(0).toUpperCase() + words[0].slice(1) + ' App' : 'New App';
        }

        function getStatusClass(status) {
            const s = status.toUpperCase();
            if (['DEPLOYED', 'SUCCESS', 'PR_OPENED'].includes(s)) return 'live';
            if (['BUILDING', 'ARCHITECTING', 'VALIDATING', 'PUBLISHING', 'HEALING', 'PENDING', 'READY_TO_BUILD'].includes(s)) return 'building';
            if (['CONSULTING', 'AWAITING_INPUT'].includes(s)) return 'queued';
            if (['FAILED', 'TIMEOUT', 'CRITICAL_FAILURE', 'BLOCKED'].includes(s)) return 'failed';
            return 'queued';
        }

        function getStatusText(status) {
            const map = {
                'DEPLOYED': 'Live', 'SUCCESS': 'Done', 'PR_OPENED': 'PR Opened',
                'BUILDING': 'Building...', 'ARCHITECTING': 'Designing...', 'VALIDATING': 'Testing...',
                'PUBLISHING': 'Publishing...', 'HEALING': 'Improving...', 'PENDING': 'Queued',
                'READY_TO_BUILD': 'Ready', 'CONSULTING': 'Consulting...', 'AWAITING_INPUT': 'Waiting...',
                'FAILED': 'Failed', 'TIMEOUT': 'Timeout', 'CRITICAL_FAILURE': 'Error', 'BLOCKED': 'Blocked'
            };
            return map[status.toUpperCase()] || status;
        }

        function addMsg(content, isUser = false) {
            const msg = document.createElement('div');
            msg.className = `msg ${isUser ? 'user' : 'system'}`;
            msg.innerHTML = `
                <div class="msg-avatar">${isUser ? 'Y' : 'G'}</div>
                <div class="msg-content">${content}</div>
            `;
            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return msg;
        }

        function addTypingIndicator() {
            const msg = document.createElement('div');
            msg.className = 'msg system';
            msg.id = 'typing-indicator';
            msg.innerHTML = `
                <div class="msg-avatar">G</div>
                <div class="msg-content"><div class="typing"><span></span><span></span><span></span></div></div>
            `;
            chatMessages.appendChild(msg);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return msg;
        }

        function removeTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        // Image upload handling
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const previewImg = document.getElementById('preview-img');
        const imageName = document.getElementById('image-name');
        const removeImageBtn = document.getElementById('remove-image');

        imageInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    pendingImage = {
                        name: file.name,
                        data: event.target.result,
                        type: file.type
                    };
                    previewImg.src = event.target.result;
                    imageName.textContent = file.name;
                    imagePreview.classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        });

        removeImageBtn.addEventListener('click', function() {
            pendingImage = null;
            imageInput.value = '';
            imagePreview.classList.remove('active');
        });

        function clearPendingImage() {
            pendingImage = null;
            imageInput.value = '';
            imagePreview.classList.remove('active');
        }

        // Track current consultation mission
        let currentMissionId = null;

        async function handleSend() {
            const input = promptInput.value.trim();
            if (!input && !pendingImage) return;

            // Build message content and payload (capture image before clearing)
            let messageContent = input;
            let displayContent = escapeHtml(input);
            const imageToSend = pendingImage;

            if (imageToSend) {
                displayContent += `<br><img class="msg-image" src="${imageToSend.data}" alt="Uploaded mockup">`;
                messageContent += `\n\n[User uploaded image: ${imageToSend.name}]`;
            }

            addMsg(displayContent, true);
            promptInput.value = '';
            clearPendingImage();
            sendBtn.disabled = true;

            addTypingIndicator();

            try {
                // Use the /gantry/voice endpoint (image saved to mission folder and included in repo)
                const payload = { message: messageContent };
                if (imageToSend) {
                    payload.image_base64 = imageToSend.data;
                    payload.image_filename = imageToSend.name;
                }
                const response = await fetch(`${API}/gantry/voice`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                removeTypingIndicator();
                const data = await response.json();

                // Handle auth error
                if (response.status === 401 || data.needs_auth) {
                    showLoginOverlay();
                    addMsg('Session expired. Please log in again.', false);
                    return;
                }

                // Handle rate limit
                if (response.status === 429) {
                    addMsg('Rate limit exceeded. Please wait a moment before trying again.', false);
                    return;
                }

                // Handle consultation loop responses
                const status = data.status;
                
                if (status === 'BUILDING') {
                    // User confirmed - build started
                    currentMissionId = data.mission_id;
                    
                    let buildMsg = `<strong>Clone Protocol Initiated!</strong><br><br>`;
                    if (data.design_target) {
                        buildMsg += `Replicating <strong>${data.design_target}</strong> interface...<br>`;
                    }
                    buildMsg += `Watch the Projects panel for progress.`;
                    addMsg(buildMsg);
                    
                    loadProjects();
                    if (data.mission_id) {
                        pollMission(data.mission_id);
                    }
                    
                } else if (status === 'AWAITING_INPUT') {
                    // AI Architect is asking a question
                    currentMissionId = data.mission_id;
                    
                    let responseText = data.speech || data.question || 'Could you tell me more?';
                    
                    // Show iteration breakdown if complex project
                    if (data.iterations && data.iterations.length > 1) {
                        responseText += `<br><br><strong>Project Breakdown (${data.total_iterations || data.iterations.length} iterations):</strong>`;
                        data.iterations.forEach(iter => {
                            const badge = iter.buildable_now 
                                ? '<span style="background:#d1e7dd;color:#0f5132;padding:2px 6px;border-radius:4px;font-size:9px;margin-left:6px;">NOW</span>'
                                : '<span style="background:#e9ecef;color:#6c757d;padding:2px 6px;border-radius:4px;font-size:9px;margin-left:6px;">LATER</span>';
                            responseText += `<br>• <strong>Iteration ${iter.iteration}:</strong> ${escapeHtml(iter.name)}${badge}`;
                            if (iter.features && iter.features.length > 0) {
                                responseText += `<br><span style="color:var(--text-muted);margin-left:16px;font-size:11px;">${iter.features.map(f => escapeHtml(f)).join(', ')}</span>`;
                            }
                        });
                    }
                    // Show features if provided (for simple projects)
                    else if (data.features && data.features.length > 0) {
                        responseText += `<br><br><strong>Proposed Features:</strong><br>`;
                        responseText += data.features.map(f => `• ${escapeHtml(f)}`).join('<br>');
                    }
                    
                    // Show design target if detected
                    if (data.design_target) {
                        responseText += `<br><br><em>Design Target: ${data.design_target}</em>`;
                    }
                    
                    // Show confidence
                    if (data.confidence && data.confidence > 0) {
                        const pct = Math.round(data.confidence * 100);
                        responseText += `<br><span style="color: var(--text-muted); font-size: 10px;">Confidence: ${pct}%</span>`;
                    }
                    
                    addMsg(responseText.replace(/\n/g, '<br>'));
                    
                } else if (status === 'error') {
                    addMsg(`<strong>Error:</strong> ${data.speech || 'Something went wrong. Please try again.'}`);
                    
                } else if (status === 'STATUS_RESPONSE' && (data.cleared !== undefined || (data.speech && data.speech.includes('Cleared') && data.speech.includes('projects')))) {
                    addMsg(data.speech || 'Done.');
                    allProjects = [];
                    renderProjects();
                    loadProjects();
                    
                } else {
                    // Generic response
                    addMsg(data.speech || 'Processing your request...');
                }
                
            } catch (err) {
                removeTypingIndicator();
                addMsg(`<strong>Connection error.</strong> Please try again.`);
                console.error('Chat error:', err);
            }

            sendBtn.disabled = false;
            promptInput.focus();
        }

        async function pollMission(missionId) {
            try {
                const response = await fetch(`${API}/gantry/status/${missionId}`);
                const data = await response.json();
                
                const terminalStates = ['SUCCESS', 'DEPLOYED', 'PR_OPENED', 'FAILED', 'BLOCKED', 'TIMEOUT', 'CRITICAL_FAILURE'];
                
                if (terminalStates.includes(data.status)) {
                    loadProjects();
                    const isSuccess = ['SUCCESS', 'DEPLOYED', 'PR_OPENED'].includes(data.status);
                    const url = extractUrl(data.speech);
                    
                    if (isSuccess) {
                        let msg = `<strong>Build Complete!</strong><br><br>`;
                        if (url) msg += `Your app is live: <a href="${url}" target="_blank">${url}</a><br><br>`;
                        msg += `${data.speech || 'Deployment successful.'}`;
                        addMsg(msg);
                    } else {
                        addMsg(`<strong>Build Failed</strong><br><br>${data.speech || 'An error occurred. Check project details for more info.'}`);
                    }
                } else {
                    loadProjects();
                    setTimeout(() => pollMission(missionId), 3000);
                }
            } catch (err) {
                setTimeout(() => pollMission(missionId), 5000);
            }
        }

        function showProjectsLoading() {
            projectsList.innerHTML = `
                <div class="empty-state" style="color: var(--text-muted);">
                    <div class="typing" style="margin: 8px 0;"><span></span><span></span><span></span></div>
                    <p>Loading projects...</p>
                </div>
            `;
            projectsCount.textContent = '(…)';
        }

        function showProjectsError(message) {
            projectsList.innerHTML = `
                <div class="empty-state" style="color: var(--red);">
                    <p><strong>${escapeHtml(message)}</strong></p>
                    <p style="font-size: 10px; color: var(--text-muted); margin-top: 6px;">Check the server is running (e.g. python src/main.py) and open this page from the same host (e.g. http://localhost:5050/).</p>
                </div>
            `;
            projectsCount.textContent = '(?)';
        }

        async function loadProjects() {
            const cacheOpts = {
                cache: 'no-store',
                credentials: 'include',
                headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache', 'X-Requested-At': String(Date.now()) }
            };
            const ts = Date.now();
            try {
                const response = await fetch((API || '') + '/gantry/missions?_=' + ts, cacheOpts);
                if (!response.ok) {
                    allProjects = [];
                    currentPage = 1;
                    showProjectsError('Could not load projects (server returned ' + response.status + ').');
                    console.error('Missions list failed:', response.status);
                    return;
                }
                const data = await response.json();
                if (!data.missions || data.missions.length === 0) {
                    allProjects = [];
                    currentPage = 1;
                    renderProjects();
                    return;
                }
                allProjects = await Promise.all(data.missions.map(async (m) => {
                    try {
                        const statusRes = await fetch((API || '') + '/gantry/status/' + m.mission_id + '?_=' + ts, cacheOpts);
                        const statusData = await statusRes.ok ? await statusRes.json() : {};
                        return { ...m, speech: statusData.speech, fullPrompt: statusData.prompt || m.prompt };
                    } catch { return m; }
                }));
                currentPage = 1;
                renderProjects();
            } catch (err) {
                console.error('Failed to load projects:', err);
                allProjects = [];
                currentPage = 1;
                showProjectsError('Could not load projects: ' + (err.message || 'network error'));
            }
        }

        function renderProjects() {
            const total = allProjects.length;
            projectsCount.textContent = `(${total})`;
            
            if (total === 0) {
                projectsList.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/></svg>
                        <h3>No projects yet</h3>
                        <p>Start a conversation to build your first app</p>
                    </div>
                `;
                pagination.style.display = 'none';
                return;
            }
            
            const totalPages = Math.ceil(total / ITEMS_PER_PAGE);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const pageProjects = allProjects.slice(start, start + ITEMS_PER_PAGE);
            
            projectsList.innerHTML = pageProjects.map(p => {
                const name = generateAppName(p.fullPrompt || p.prompt);
                const statusClass = getStatusClass(p.status);
                const statusText = getStatusText(p.status);
                const url = extractUrl(p.speech);
                const desc = (p.fullPrompt || p.prompt).length > 60 ? (p.fullPrompt || p.prompt).substring(0, 60) + '...' : (p.fullPrompt || p.prompt);
                const repoName = name.toLowerCase().replace(/\s+/g, '-');
                const githubUrl = `https://github.com/Jarvis2021/${repoName}`;
                const isFailed = ['FAILED', 'TIMEOUT', 'CRITICAL_FAILURE', 'BLOCKED', 'PUBLISH_FAILED'].includes(p.status.toUpperCase());
                const failReason = isFailed && p.speech ? p.speech.substring(0, 50) + '...' : '';
                const isLive = ['DEPLOYED', 'SUCCESS', 'PR_OPENED'].includes(p.status.toUpperCase());
                const showViewLive = isLive && url;
                const showGitHub = isLive;
                const showRetry = isFailed;
                const showExtend = isLive; // Show "Extend" for deployed projects
                
                return `
                    <div class="project-card">
                        <div class="project-row">
                            <span class="project-name">${escapeHtml(name)}</span>
                            <span class="project-id">#${p.mission_id.substring(0, 6)}</span>
                        </div>
                        <div class="project-desc">${escapeHtml(desc)}${isFailed && failReason ? '<br><em style="color:var(--red)">' + escapeHtml(failReason) + '</em>' : ''}</div>
                        <div class="project-footer">
                            <span class="status-badge ${statusClass}">${statusText}</span>
                            <div class="project-actions">
                                ${showRetry ? `<button type="button" class="action-link retry-btn" data-mission-id="${p.mission_id}" title="Retry build from scratch">Retry</button>` : ''}
                                ${showExtend ? `<button type="button" class="action-link extend-btn" data-mission-id="${p.mission_id}" data-project-name="${escapeHtml(name)}" title="Add features to this project">Extend</button>` : ''}
                                ${showViewLive ? `<a href="${url}" target="_blank" class="action-link">View Live</a>` : ''}
                                ${showGitHub ? `<a href="${githubUrl}" target="_blank" class="action-link">GitHub</a>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Retry buttons: delegate click
            projectsList.querySelectorAll('.retry-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const mid = btn.getAttribute('data-mission-id');
                    if (!mid) return;
                    btn.disabled = true;
                    btn.textContent = 'Retrying...';
                    try {
                        const res = await fetch(`${API}/gantry/missions/${mid}/retry`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ deploy: true, publish: true })
                        });
                        const data = await res.json();
                        if (res.ok && data.status === 'BUILDING') {
                            loadProjects();
                            if (data.mission_id) pollMission(data.mission_id);
                            addMsg(`<strong>Retrying build.</strong> Watch the Projects panel for progress.`);
                        } else {
                            addMsg(`<strong>Retry failed:</strong> ${data.speech || 'Unknown error'}`);
                        }
                    } catch (e) {
                        addMsg(`<strong>Retry failed:</strong> ${e.message}`);
                    }
                    loadProjects();
                });
            });
            
            // Extend buttons: delegate click
            projectsList.querySelectorAll('.extend-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const mid = btn.getAttribute('data-mission-id');
                    const projectName = btn.getAttribute('data-project-name') || 'this project';
                    if (!mid) return;
                    
                    // Prompt user for new features
                    const features = prompt(`What features would you like to add to "${projectName}"?\n\nExamples:\n• Add a dashboard with charts\n• Add user authentication\n• Add dark mode toggle`);
                    
                    if (!features || !features.trim()) return;
                    
                    btn.disabled = true;
                    btn.textContent = 'Extending...';
                    
                    try {
                        const res = await fetch(`${API}/gantry/missions/${mid}/extend`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ features: features.trim(), deploy: true, publish: true })
                        });
                        const data = await res.json();
                        if (res.ok && data.status === 'BUILDING') {
                            loadProjects();
                            if (data.mission_id) pollMission(data.mission_id);
                            addMsg(`<strong>Extending ${projectName}!</strong><br>Adding: ${escapeHtml(features)}<br><br>Watch the Projects panel for progress.`);
                        } else {
                            addMsg(`<strong>Extend failed:</strong> ${data.detail || data.speech || 'Unknown error'}`);
                            btn.disabled = false;
                            btn.textContent = 'Extend';
                        }
                    } catch (e) {
                        addMsg(`<strong>Extend failed:</strong> ${e.message}`);
                        btn.disabled = false;
                        btn.textContent = 'Extend';
                    }
                });
            });
            
            if (totalPages > 1) {
                pagination.style.display = 'flex';
                pageInfo.textContent = `${currentPage} / ${totalPages}`;
                prevBtn.disabled = currentPage === 1;
                nextBtn.disabled = currentPage === totalPages;
            } else {
                pagination.style.display = 'none';
            }
        }

        // Event listeners
        sendBtn.addEventListener('click', handleSend);
        promptInput.addEventListener('keydown', (e) => {
            // Enter without Shift sends the message, Shift+Enter adds a newline
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSend();
            }
        });
        
        // Auto-resize textarea as user types
        promptInput.addEventListener('input', () => {
            promptInput.style.height = 'auto';
            promptInput.style.height = Math.min(promptInput.scrollHeight, 300) + 'px';
        });
        
        if (refreshBtn) refreshBtn.addEventListener('click', function onRefresh() {
            refreshBtn.disabled = true;
            refreshBtn.textContent = 'Loading...';
            showProjectsLoading();
            loadProjects().finally(function() {
                if (refreshBtn) { refreshBtn.disabled = false; refreshBtn.textContent = 'Refresh'; }
            });
        });
        
        const clearBtn = document.getElementById('clear-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', async function onClear() {
                if (!confirm('Clear all projects from the database? This cannot be undone. Mission folders on disk are kept for audit.')) return;
                clearBtn.disabled = true;
                clearBtn.textContent = 'Clearing...';
                try {
                    const res = await fetch((API || '') + '/gantry/missions/clear', {
                        method: 'POST',
                        credentials: 'include',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await res.json().catch(function() { return {}; });
                    if (res.ok) {
                        const n = data.cleared ?? 0;
                        addMsg('<strong>Cleared ' + n + ' projects from the database.</strong> You can start fresh.');
                        allProjects = [];
                        renderProjects();
                        await loadProjects();
                    } else if (res.status === 401) {
                        addMsg('<strong>Please log in to clear projects.</strong>');
                        showLoginOverlay();
                    } else {
                        addMsg('<strong>Clear failed:</strong> ' + (data.speech || data.error || 'Unknown error'));
                    }
                } catch (e) {
                    addMsg('<strong>Clear failed:</strong> ' + (e.message || 'network error'));
                }
                clearBtn.disabled = false;
                clearBtn.textContent = 'Clear all';
            });
        }
        
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) { currentPage--; renderProjects(); }
        });
        
        nextBtn.addEventListener('click', () => {
            const totalPages = Math.ceil(allProjects.length / ITEMS_PER_PAGE);
            if (currentPage < totalPages) { currentPage++; renderProjects(); }
        });

        // Initial load
        checkAuth();  // Check if already logged in
        loadProjects();
        
        // Auto-refresh every 10s
        setInterval(loadProjects, 10000);
    </script>
</body>
</html>
