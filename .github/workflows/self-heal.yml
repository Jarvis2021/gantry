# =============================================================================
# GANTRY SELF-HEALING WORKFLOW
# =============================================================================
# When tests fail on develop branch, this workflow:
#   1. Captures the failure logs
#   2. Uses AI to analyze and propose fixes
#   3. Creates a PR with the fix
#
# This makes the Gantry repo itself self-healing, just like the apps it builds.
# =============================================================================

name: Self-Heal on Failure

on:
  workflow_run:
    workflows: ["Gantry CI"]
    types:
      - completed

jobs:
  self-heal:
    name: üîß Self-Heal Failed Tests
    runs-on: ubuntu-latest
    # Only run on develop branch failures
    if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'develop' }}
    
    permissions:
      contents: write
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: develop
          fetch-depth: 0

      - name: Get failure logs
        uses: actions/github-script@v7
        id: get-logs
        with:
          script: |
            const run_id = context.payload.workflow_run.id;
            const jobs = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: run_id
            });
            
            let failedJobs = jobs.data.jobs.filter(job => job.conclusion === 'failure');
            let errorLogs = [];
            
            for (const job of failedJobs) {
              const logs = await github.rest.actions.downloadJobLogsForWorkflowRun({
                owner: context.repo.owner,
                repo: context.repo.repo,
                job_id: job.id
              });
              errorLogs.push({
                name: job.name,
                log: logs.data.substring(0, 5000) // Limit log size
              });
            }
            
            return JSON.stringify(errorLogs);

      - name: Create issue for manual review
        uses: actions/github-script@v7
        with:
          script: |
            const logs = JSON.parse(${{ steps.get-logs.outputs.result }});
            const logSummary = logs.map(l => `### ${l.name}\n\`\`\`\n${l.log.substring(0, 2000)}\n\`\`\``).join('\n\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üîß Self-Heal Required: CI Failed on develop`,
              body: `## CI Failure Detected
            
            The CI pipeline failed on the \`develop\` branch. Review the errors below and fix them.
            
            **Workflow Run:** [#${context.payload.workflow_run.run_number}](${context.payload.workflow_run.html_url})
            **Commit:** ${context.payload.workflow_run.head_sha.substring(0, 7)}
            **Branch:** develop
            
            ## Failed Jobs
            
            ${logSummary}
            
            ## Suggested Actions
            
            1. Review the error logs above
            2. Fix the failing tests locally
            3. Push the fix to develop
            4. Close this issue when resolved
            
            ---
            *This issue was automatically created by the Gantry Self-Healing system.*
            `,
              labels: ['self-heal', 'ci-failure', 'automated']
            });

      - name: Notify in PR comments (if from PR)
        if: github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // Find associated PR
            const prs = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
              state: 'open'
            });
            
            if (prs.data.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prs.data[0].number,
                body: `‚ö†Ô∏è **CI Failed** - Self-healing initiated. Check the [workflow run](${context.payload.workflow_run.html_url}) for details.`
              });
            }
